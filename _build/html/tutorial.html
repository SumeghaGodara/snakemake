

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>7. Tutorial &#8212; snakemake2019 0.0.1 documentation</title>
    <link rel="stylesheet" href="_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="6. Introduction" href="introduction.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="introduction.html" title="6. Introduction"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="toc.html">snakemake2019 0.0.1 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar">
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Contents</h2>
    <div class="sidebar-localtoc">
      <ul>
<li><a class="reference internal" href="#">7. Tutorial</a><ul>
<li><a class="reference internal" href="#software-we-re-going-to-use">7.1. Software we’re going to use</a></li>
<li><a class="reference internal" href="#working-on-binder">7.2. Working on binder</a></li>
<li><a class="reference internal" href="#running-snakemake">7.3. Running snakemake!</a><ul>
<li><a class="reference internal" href="#getting-started-your-first-snakefile">7.3.1. Getting started - your first Snakefile</a></li>
<li><a class="reference internal" href="#updating-the-snakefile-to-track-inputs-and-outputs">7.3.2. Updating the Snakefile to track inputs and outputs</a></li>
<li><a class="reference internal" href="#forcibly-re-running-things">7.3.3. Forcibly re-running things</a></li>
<li><a class="reference internal" href="#multiple-rules">7.3.4. Multiple rules</a></li>
<li><a class="reference internal" href="#a-first-refactoring-adding-a-better-default-rule">7.3.5. A first refactoring: adding a better default rule</a></li>
<li><a class="reference internal" href="#a-second-refactoring-doing-a-bit-of-templating">7.3.6. A second refactoring: doing a bit of templating</a></li>
<li><a class="reference internal" href="#refactoring-3-templating-output-files-too">7.3.7. Refactoring 3: templating output files, too</a></li>
<li><a class="reference internal" href="#adding-some-more-files">7.3.8. Adding some more files</a></li>
<li><a class="reference internal" href="#rerunning-snakemake">7.3.9. Rerunning snakemake</a></li>
<li><a class="reference internal" href="#building-out-the-workflow">7.3.10. Building out the workflow</a></li>
<li><a class="reference internal" href="#providing-input-files-explicitly-to-the-multiqc-rule">7.3.11. Providing input files explicitly to the multiqc rule</a></li>
<li><a class="reference internal" href="#refactoring-this-to-make-it-slightly-more-concise">7.3.12. Refactoring this to make it slightly more concise –</a></li>
<li><a class="reference internal" href="#digression-what-files-does-snakemake-check-in-order-to-decide-about-rerunning">7.3.13. Digression: what files does snakemake check in order to decide about rerunning?</a></li>
<li><a class="reference internal" href="#making-a-clean-rule">7.3.14. Making a <code class="docutils literal notranslate"><span class="pre">clean</span></code> rule</a></li>
<li><a class="reference internal" href="#digression-running-things-in-parallel">7.3.15. Digression: running things in parallel</a></li>
<li><a class="reference internal" href="#doing-more-things-in-our-workflow">7.3.16. Doing more things in our workflow.</a></li>
</ul>
</li>
<li><a class="reference internal" href="#more-advanced-snakemake">7.4. More advanced snakemake</a><ul>
<li><a class="reference internal" href="#dry-run">7.4.1. Dry run</a></li>
<li><a class="reference internal" href="#running-things-in-parallel-revisited">7.4.2. Running things in parallel, revisited</a></li>
<li><a class="reference internal" href="#specifying-software-required-for-a-rule">7.4.3. Specifying software required for a rule</a></li>
<li><a class="reference internal" href="#outputting-the-entire-workflow-diagram">7.4.4. Outputting the entire workflow diagram</a></li>
<li><a class="reference internal" href="#adding-in-some-python">7.4.5. Adding in some Python…</a></li>
<li><a class="reference internal" href="#final-thoughts-writing-your-own-snakefile">7.4.6. Final thoughts - writing your own snakefile</a></li>
</ul>
</li>
<li><a class="reference internal" href="#thinking-about-workflows-a-strong-er-argument">7.5. Thinking about workflows - a strong(er) argument</a><ul>
<li><a class="reference internal" href="#dealing-with-complexity">7.5.1. Dealing with complexity</a></li>
<li><a class="reference internal" href="#go-forth-and-workflow">7.5.2. Go forth and Workflow!</a></li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
  </div>
</div>
  <h4>Previous topic</h4>
  <p class="topless"><a href="introduction.html"
                        title="previous chapter">6. Introduction</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/tutorial.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="toc.html">Docs</a></li>
              
              <li>7. Tutorial</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="tutorial">
<h1>7. Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h1>
<div class="section" id="software-we-re-going-to-use">
<h2>7.1. Software we’re going to use<a class="headerlink" href="#software-we-re-going-to-use" title="Permalink to this headline">¶</a></h2>
<p>We’re going to be using <a class="reference external" href="https://conda.io/en/latest/">conda</a> and <a class="reference external" href="https://snakemake.readthedocs.io/en/stable/">snakemake</a>, a well as packages from <a class="reference external" href="https://bioconda.github.io">bioconda</a>. If you wanted to run all of this on your own computer, you’ll need to follow the bioconda install instructions.</p>
<p>We’ll be implementing a short read quality check and trimming pipeline, using <a class="reference external" href="https://www.bioinformatics.babraham.ac.uk/projects/fastqc/">fastqc</a>, <a class="reference external" href="http://www.usadellab.org/cms/?page=trimmomatic">trimmomatic</a>, and <a class="reference external" href="https://multiqc.info/">multiqc</a>. No worries if you don’t know what any of this means, it’s not super critical to the snakemake side of things :)</p>
<p>You can see the full set of installed software requirements <a class="reference external" href="https://github.com/ctb/2019-snakemake-ucdavis/blob/master/binder/environment.yml">here</a>, in a conda <code class="docutils literal notranslate"><span class="pre">environment.yml</span></code> file.</p>
<p>You could use this install file to run everything we’re doing today on your laptop, with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">env</span> <span class="n">create</span> <span class="o">--</span><span class="n">file</span> <span class="n">environment</span><span class="o">.</span><span class="n">yml</span> <span class="o">-</span><span class="n">n</span> <span class="n">smake</span>
<span class="n">conda</span> <span class="n">activate</span> <span class="n">smake</span>
</pre></div>
</div>
</div>
<div class="section" id="working-on-binder">
<h2>7.2. Working on binder<a class="headerlink" href="#working-on-binder" title="Permalink to this headline">¶</a></h2>
<p>We’re going to use mybinder.org, a fantastic service that lets us run demonstrations and short workshops in the cloud! Click on the button below to get started:</p>
<p><a class="reference external" href="https://mybinder.org/v2/gh/ctb/2019-snakemake-ucdavis/feb2019?urlpath=rstudio"><img alt="https://mybinder.org/badge_logo.svg" src="https://mybinder.org/badge_logo.svg" />Binder</a></p>
<p>We’re mostly going to work in the file editor and the terminal; to get started, open the terminal, and execute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PS1</span><span class="o">=</span><span class="s1">&#39;$ &#39;</span>
</pre></div>
</div>
<p>to get a shorter prompt.</p>
</div>
<div class="section" id="running-snakemake">
<h2>7.3. Running snakemake!<a class="headerlink" href="#running-snakemake" title="Permalink to this headline">¶</a></h2>
<div class="section" id="getting-started-your-first-snakefile">
<h3>7.3.1. Getting started - your first Snakefile<a class="headerlink" href="#getting-started-your-first-snakefile" title="Permalink to this headline">¶</a></h3>
<p>Create a new text file (<code class="docutils literal notranslate"><span class="pre">File</span></code>, <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">File</span></code>, <code class="docutils literal notranslate"><span class="pre">Text</span> <span class="pre">file</span></code>) and write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="n">fastqc_a_file</span><span class="p">:</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;fastqc data/0Hour_001_1.fq.gz&quot;</span>
</pre></div>
</div>
<p>(I suggest copy/pasting this into RStudio.)</p>
<p>Then save it as a file named <code class="docutils literal notranslate"><span class="pre">Snakefile</span></code>.</p>
<p>Now, run snakemake:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snakemake</span>
</pre></div>
</div>
<p>and you should see:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Building</span> <span class="n">DAG</span> <span class="n">of</span> <span class="n">jobs</span><span class="o">...</span>
<span class="n">Using</span> <span class="n">shell</span><span class="p">:</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">Provided</span> <span class="n">cores</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Rules</span> <span class="n">claiming</span> <span class="n">more</span> <span class="n">threads</span> <span class="n">will</span> <span class="n">be</span> <span class="n">scaled</span> <span class="n">down</span><span class="o">.</span>
<span class="o">...</span>
<span class="n">Approx</span> <span class="mi">95</span><span class="o">%</span> <span class="n">complete</span> <span class="k">for</span> <span class="mi">0</span><span class="n">Hour_001_1</span><span class="o">.</span><span class="n">fq</span><span class="o">.</span><span class="n">gz</span>
<span class="n">Analysis</span> <span class="n">complete</span> <span class="k">for</span> <span class="mi">0</span><span class="n">Hour_001_1</span><span class="o">.</span><span class="n">fq</span><span class="o">.</span><span class="n">gz</span>
<span class="p">[</span><span class="n">Wed</span> <span class="n">Feb</span> <span class="mi">27</span> <span class="mi">13</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mi">51</span> <span class="mi">2019</span><span class="p">]</span>
<span class="n">Finished</span> <span class="n">job</span> <span class="mf">0.</span>
<span class="mi">1</span> <span class="n">of</span> <span class="mi">1</span> <span class="n">steps</span> <span class="p">(</span><span class="mi">100</span><span class="o">%</span><span class="p">)</span> <span class="n">done</span>
<span class="n">Complete</span> <span class="n">log</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/.</span><span class="n">snakemake</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="mi">2019</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">27</span><span class="n">T130941</span><span class="o">.</span><span class="mf">260352.</span><span class="n">snakemake</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>and there will be two new files,</p>
<blockquote>
<div>Point to note: snakemake configuration file is by default called <code class="docutils literal notranslate"><span class="pre">Snakefile</span></code></div></blockquote>
</div>
<div class="section" id="updating-the-snakefile-to-track-inputs-and-outputs">
<h3>7.3.2. Updating the Snakefile to track inputs and outputs<a class="headerlink" href="#updating-the-snakefile-to-track-inputs-and-outputs" title="Permalink to this headline">¶</a></h3>
<p>At the moment this is basically just a shell script with extra syntax… what’s the point?</p>
<p>Well, shell scripts - and this snakefile, too - will rerun the command every time you run the file, even if there’s no reason to do so because the file hasn’t changed.</p>
<p><strong>Digression:</strong> This is particularly important for large or long workflows, where you’re dealing with 10s to 100s of files that may take hours to days to process! It can be hard to figure out which files to rerun, but (spoiler alert) snakemake can really help you do this!</p>
<p>It’s hard to track this kind of thing in a shell script - I usually just comment out the lines I don’t want run, or break my commands up into multiple shell scripts so they don’t take so long - but with snakemake, you can annotate the rule with input and output files!</p>
<p>Change your snakefile to look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="n">fastqc_a_file</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;data/0Hour_001_1.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;data/0Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data/0Hour_001_1_fastqc.zip&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;fastqc data/0Hour_001_1.fq.gz&quot;</span>
</pre></div>
</div>
<p>here, we’ve annotated the rule with the required <strong>input</strong> file, as well as the expected <strong>output</strong> files.</p>
<p>Question: how do we know what the output files are?</p>
<p>Now run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snakemake</span>
</pre></div>
</div>
<p>and you should see:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Building</span> <span class="n">DAG</span> <span class="n">of</span> <span class="n">jobs</span><span class="o">...</span>
<span class="n">Nothing</span> <span class="n">to</span> <span class="n">be</span> <span class="n">done</span><span class="o">.</span>
<span class="n">Complete</span> <span class="n">log</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jovyan</span><span class="o">/.</span><span class="n">snakemake</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="mi">2019</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">27</span><span class="n">T132031</span><span class="o">.</span><span class="mf">813143.</span><span class="n">snakemake</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>What happened??</p>
<p>snakemake looked at the file, saw that the output files existed, and figured out that it didn’t need to do anything!</p>
</div>
<div class="section" id="forcibly-re-running-things">
<h3>7.3.3. Forcibly re-running things<a class="headerlink" href="#forcibly-re-running-things" title="Permalink to this headline">¶</a></h3>
<p>You can tell snakemake to run the rule no matter what with <code class="docutils literal notranslate"><span class="pre">-f</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snakemake</span> <span class="o">-</span><span class="n">f</span>
</pre></div>
</div>
<p>You can also remove an output file and it will automatically re-run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rm</span> <span class="n">data</span><span class="o">/*.</span><span class="n">html</span>
<span class="n">snakemake</span>
</pre></div>
</div>
<blockquote>
<div>Note that you don’t need to remove <em>all</em> the output files to rerun a command - just remove <em>one</em> of them.</div></blockquote>
<p>You can <em>also</em> update the timestamp on an <em>input</em> file, and snakemake will figure out that the output file is older than the input file, and rerun things.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">touch</span> <span class="n">data</span><span class="o">/*.</span><span class="n">fq</span><span class="o">.</span><span class="n">gz</span>
<span class="n">snakemake</span>
</pre></div>
</div>
<p>This will become important later :)</p>
</div>
<div class="section" id="multiple-rules">
<h3>7.3.4. Multiple rules<a class="headerlink" href="#multiple-rules" title="Permalink to this headline">¶</a></h3>
<p>Let’s add a rule to run fastqc on a second file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="n">fastqc_a_file</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;data/0Hour_001_1.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;data/0Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data/0Hour_001_1_fastqc.zip&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;fastqc data/0Hour_001_1.fq.gz&quot;</span>

<span class="n">rule</span> <span class="n">fastqc_a_file2</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;data/6Hour_001_1.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;data/6Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data/6Hour_001_1_fastqc.zip&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;fastqc data/6Hour_001_1.fq.gz&quot;</span>
</pre></div>
</div>
<p>Now, if you run this, the Right Thing won’t happen: snakemake will do nothing.  Why?</p>
<p>Well, snakemake only runs the <em>first</em> rule in a Snakefile, by default. You can give a rule name on the command line, if you like, <strong>or</strong> you can tell snakemake what output file(s) you want. Let’s do the latter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snakemake</span> <span class="n">data</span><span class="o">/</span><span class="mi">0</span><span class="n">Hour_001_1_fastqc</span><span class="o">.</span><span class="n">html</span> <span class="n">data</span><span class="o">/</span><span class="mi">6</span><span class="n">Hour_001_1_fastqc</span><span class="o">.</span><span class="n">html</span>
</pre></div>
</div>
<p>and now you should see the second fastqc command run, with the appropriate output files!</p>
<p>Note that snakemake only runs the second rule, because it looks at the output files and sees that the first file you wanted, <code class="docutils literal notranslate"><span class="pre">0Hour_001_1_fastqc.html</span></code> already exists!</p>
<p>Points to make:</p>
<ul class="simple">
<li>this is pretty long compared to the same shell script…</li>
<li>specifying which file or rule you want is kind of annoying…</li>
</ul>
</div>
<div class="section" id="a-first-refactoring-adding-a-better-default-rule">
<h3>7.3.5. A first refactoring: adding a better default rule<a class="headerlink" href="#a-first-refactoring-adding-a-better-default-rule" title="Permalink to this headline">¶</a></h3>
<p>Let’s start refactoring (cleaning up) this Snakefile.</p>
<p>First, let’s add a rule at the top:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="nb">all</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;data/0Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data/6Hour_001_1_fastqc.html&quot;</span>

<span class="n">rule</span> <span class="n">fastqc_a_file</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;data/0Hour_001_1.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;data/0Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data/0Hour_001_1_fastqc.zip&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;fastqc data/0Hour_001_1.fq.gz&quot;</span>

<span class="n">rule</span> <span class="n">fastqc_a_file2</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;data/6Hour_001_1.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;data/6Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data/6Hour_001_1_fastqc.zip&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;fastqc data/6Hour_001_1.fq.gz&quot;</span>
</pre></div>
</div>
<p>this rule, by convention called <code class="docutils literal notranslate"><span class="pre">all</span></code>, is a default rule that produces all the output files. But it’s a bit weird! It’s all input, and no output!</p>
<p>This is a blank rule that gathers together all of the various files you want produced, and says “hey, snakemake, I depend on all of these files for my input - make them for me!” And then, once those files are all there, it …does nothing.</p>
<p>Yep, this is perfectly legal in snakemake, and it’s one way to make your life easier.</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">snakemake</span> <span class="pre">-f</span></code> no longer works properly, because <code class="docutils literal notranslate"><span class="pre">-f</span></code> only forces rerunning a single rule. To rerun everything, you can run <code class="docutils literal notranslate"><span class="pre">touch</span> <span class="pre">data/*.fq.gz</span></code> to make all the output files stale; or <code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">data/*.html</span></code> to remove some of the output files.</p>
</div>
<div class="section" id="a-second-refactoring-doing-a-bit-of-templating">
<h3>7.3.6. A second refactoring: doing a bit of templating<a class="headerlink" href="#a-second-refactoring-doing-a-bit-of-templating" title="Permalink to this headline">¶</a></h3>
<p>There’s a lot of repetition in each of these rules. Let’s collapse it down a little bit by replacing the filename in the fastqc command with a magic variable, <code class="docutils literal notranslate"><span class="pre">{input}</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="nb">all</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;data/0Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data/6Hour_001_1_fastqc.html&quot;</span>

<span class="n">rule</span> <span class="n">fastqc_a_file</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;data/0Hour_001_1.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;data/0Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data/0Hour_001_1_fastqc.zip&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;fastqc </span><span class="si">{input}</span><span class="s2">&quot;</span>

<span class="n">rule</span> <span class="n">fastqc_a_file2</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;data/6Hour_001_1.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;data/6Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data/6Hour_001_1_fastqc.zip&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;fastqc </span><span class="si">{input}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>This all works as before, but now the rule is a bit more generic and will work with any input file. Sort of.</p>
</div>
<div class="section" id="refactoring-3-templating-output-files-too">
<h3>7.3.7. Refactoring 3: templating output files, too<a class="headerlink" href="#refactoring-3-templating-output-files-too" title="Permalink to this headline">¶</a></h3>
<p>What do I mean, sort of?</p>
<p>Well, the output filenames ALSO depend on the input file names in some way - specifically, fastqc replace part of the filename with <code class="docutils literal notranslate"><span class="pre">_fastqc.html</span></code> and <code class="docutils literal notranslate"><span class="pre">_fastqc.zip</span></code> to make its two output files.</p>
<p>Let’s rewrite the rule using some snakemake pattern matching:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="nb">all</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;data/0Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data/6Hour_001_1_fastqc.html&quot;</span>

<span class="n">rule</span> <span class="n">fastqc_a_file</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_fastqc.zip&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;fastqc </span><span class="si">{input}</span><span class="s2">&quot;</span>

<span class="n">rule</span> <span class="n">fastqc_a_file2</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_fastqc.zip&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;fastqc </span><span class="si">{input}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>What we’ve done here is tell snakemake that anytime we say we <em>want</em> a file that ends with <code class="docutils literal notranslate"><span class="pre">_fastqc.html</span></code>, it should look for a file that ends in <code class="docutils literal notranslate"><span class="pre">.fq.gz</span></code> and then run <code class="docutils literal notranslate"><span class="pre">fastqc</span></code> on it.</p>
<p>Try running this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snakemake</span>
</pre></div>
</div>
<p>Oh no! We get a <code class="docutils literal notranslate"><span class="pre">AmbiguousRuleException:</span></code>! What’s going on?</p>
<p>Well, if you look at the rule above, we’ve given snakemake two different rules to produce the same file(s)! <code class="docutils literal notranslate"><span class="pre">fastqc_a_file</span></code> and <code class="docutils literal notranslate"><span class="pre">fastqc_a_file2</span></code> are now identical rules! snakemake doesn’t like that.</p>
<p>Let’s remove one, to get a trimmer, leaner, and above all <em>functional</em> snakefile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="nb">all</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;data/0Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data/6Hour_001_1_fastqc.html&quot;</span>

<span class="n">rule</span> <span class="n">fastqc_a_file</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_fastqc.zip&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;fastqc </span><span class="si">{input}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>and THAT should now work just fine!</p>
</div>
<div class="section" id="adding-some-more-files">
<h3>7.3.8. Adding some more files<a class="headerlink" href="#adding-some-more-files" title="Permalink to this headline">¶</a></h3>
<p>Now here’s the fun bit – if you look in the data directory, you’ll see that there are actually 8 files in there. Let’s modify the snakefile to run fastqc on all of them!</p>
<p>How should we do that? (Give it a try!)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="nb">all</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;data/0Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data/6Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data/6Hour_001_2_fastqc.html&quot;</span>

<span class="n">rule</span> <span class="n">fastqc_a_file</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{arglebarf}</span><span class="s2">.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{arglebarf}</span><span class="s2">_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="si">{arglebarf}</span><span class="s2">_fastqc.zip&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;fastqc </span><span class="si">{input}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="rerunning-snakemake">
<h3>7.3.9. Rerunning snakemake<a class="headerlink" href="#rerunning-snakemake" title="Permalink to this headline">¶</a></h3>
<p>Note you can just run snakemake whenever you want. It won’t do anything unless something’s changed.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snakemake</span>
</pre></div>
</div>
<p>It’s actually kind of soothing…</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snakemake</span>
<span class="n">snakemake</span>
<span class="n">snakemake</span>
</pre></div>
</div>
</div>
<div class="section" id="building-out-the-workflow">
<h3>7.3.10. Building out the workflow<a class="headerlink" href="#building-out-the-workflow" title="Permalink to this headline">¶</a></h3>
<p>So, we’ve gotten fastqc sorted out. What’s next?</p>
<p>Let’s add in a new rule - multiqc, to summarize our fastqc results.</p>
<p>multiqc takes a directory name under which there are one or more fastqc reports, and then summarizes them.</p>
<p>Running it on the command line,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">multiqc</span> <span class="n">data</span>
</pre></div>
</div>
<p>you can see that it creates two outputs, <code class="docutils literal notranslate"><span class="pre">multiqc_report.html</span></code> and the directory <code class="docutils literal notranslate"><span class="pre">multiqc_data/</span></code> which contains a bunch of files. Let’s create a snakemake rule for this; add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="n">run_multiqc</span><span class="p">:</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;multiqc_report.html&quot;</span><span class="p">,</span>
    <span class="n">directory</span><span class="p">(</span><span class="s2">&quot;multiqc_data&quot;</span><span class="p">)</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;multiqc data/&quot;</span>
</pre></div>
</div>
<p>to the bottom of the file. (Note, you need to tell snakemake if an output is a directory.)</p>
<p>Now run it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snakemake</span> <span class="n">run_multiqc</span>
</pre></div>
</div>
<p>This …doesn’t really do what we want, for a few reasons.</p>
<p>First of all, you have to specify the rule name or else snakemake doesn’t run anything. <strong>How do we fix this??</strong></p>
<p>Second of all, <code class="docutils literal notranslate"><span class="pre">multiqc_report.html</span></code> already exists, so snakemake doesn’t run the rule. <strong>How do we actually test the rule??</strong></p>
<p>Third of all, the multiqc rule has no input dependencies. How do we specify them??</p>
<p>Let’s fix the first two things first:</p>
<ul class="simple">
<li>add <code class="docutils literal notranslate"><span class="pre">multiqc_report.html</span></code> to the inputs for the first all.</li>
<li>then remove <code class="docutils literal notranslate"><span class="pre">multiqc_report.html</span></code> and re-run snakemake.</li>
</ul>
<p>Your snakefile should look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="nb">all</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;data/0Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data/6Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;multiqc_report.html&quot;</span>
    
<span class="n">rule</span> <span class="n">fastqc_a_file</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_fastqc.zip&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;fastqc </span><span class="si">{input}</span><span class="s2">&quot;</span>
    
<span class="n">rule</span> <span class="n">run_multiqc</span><span class="p">:</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;multiqc_report.html&quot;</span><span class="p">,</span>
    <span class="n">directory</span><span class="p">(</span><span class="s2">&quot;multiqc_data&quot;</span><span class="p">)</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;multiqc data/&quot;</span>
</pre></div>
</div>
<p>Yay, that seems to work!</p>
<p>Points to note:</p>
<ul class="simple">
<li>other than the first rule, rules can be in any order</li>
<li>the rule name doesn’t really matter, it’s mostly for debugging. It just needs to be “boring” (text, underscores, etc. only)</li>
</ul>
</div>
<div class="section" id="providing-input-files-explicitly-to-the-multiqc-rule">
<h3>7.3.11. Providing input files explicitly to the multiqc rule<a class="headerlink" href="#providing-input-files-explicitly-to-the-multiqc-rule" title="Permalink to this headline">¶</a></h3>
<p>The third problem, that multiqc doesn’t have any input dependencies, is a bit harder to fix.</p>
<p>(Why do we want to fix this? Well, this is how snakemake tracks “out of date” files - if we don’t specify input dependencies, then we may update one of the fastqc results that multiqc uses, but snakemake won’t re-run multiqc on it, and our multiqc results will be out of date.)</p>
<p>Basically we need to tell snakemake <em>all</em> of the files that we want. On the face of it, that’s easy – change the rule like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="n">run_multiqc</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;data/0Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data/6Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;multiqc_report.html&quot;</span><span class="p">,</span>
    <span class="n">directory</span><span class="p">(</span><span class="s2">&quot;multiqc_data&quot;</span><span class="p">)</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;multiqc data/&quot;</span>
</pre></div>
</div>
<p>This will work, but there are two reasons this is not great.</p>
<p>First, we’re repeating ourselves. Those input files are in the <code class="docutils literal notranslate"><span class="pre">all</span></code> rule above, and also in this rule. If you are as forgetful as I am, this means that you run the risk of updating one rule and not the other, and getting out of sync.</p>
<p>Second, we’re explicitly listing out the files that we want produced. That’s not super great because it makes it annoying to add files.</p>
<p>We can fix the first issue by using <strong>variables</strong>. The second issue requires a bit more advanced programming, and we’ll leave it to the very end.</p>
<p>To use variables, let’s make a Python list at the very top, containing all of our expected output files from fastqc:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fastqc_output</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;data/0Hour_001_1_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/6Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
  <span class="s2">&quot;data/0Hour_001_2_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/6Hour_001_2_fastqc.html&quot;</span><span class="p">,</span>
  <span class="s2">&quot;data/0Hour_002_1_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/6Hour_002_1_fastqc.html&quot;</span><span class="p">,</span>
  <span class="s2">&quot;data/0Hour_002_2_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/6Hour_002_2_fastqc.html&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>and modify the <code class="docutils literal notranslate"><span class="pre">all</span></code> and <code class="docutils literal notranslate"><span class="pre">multiqc</span></code> rules to contain this list. The final snakefile looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fastqc_output</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;data/0Hour_001_1_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/6Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
  <span class="s2">&quot;data/0Hour_001_2_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/6Hour_001_2_fastqc.html&quot;</span><span class="p">,</span>
  <span class="s2">&quot;data/0Hour_002_1_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/6Hour_002_1_fastqc.html&quot;</span><span class="p">,</span>
  <span class="s2">&quot;data/0Hour_002_2_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/6Hour_002_2_fastqc.html&quot;</span><span class="p">]</span>

<span class="n">rule</span> <span class="nb">all</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="n">fastqc_output</span><span class="p">,</span>
    <span class="s2">&quot;multiqc_report.html&quot;</span>
    
<span class="n">rule</span> <span class="n">fastqc_a_file</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_fastqc.zip&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;fastqc </span><span class="si">{input}</span><span class="s2">&quot;</span>
    
<span class="n">rule</span> <span class="n">run_multiqc</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="n">fastqc_output</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;multiqc_report.html&quot;</span><span class="p">,</span>
    <span class="n">directory</span><span class="p">(</span><span class="s2">&quot;multiqc_data&quot;</span><span class="p">)</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;multiqc data/&quot;</span>
</pre></div>
</div>
<p>Points to note:</p>
<ul class="simple">
<li>quoted strings are …strings (filename, usually)</li>
<li>you can also use Python to create, manipulate, etc. filenames or lists of them, and it will work fine!</li>
<li>this includes loading in filenames from spreadsheets, etc. - more on that later.</li>
</ul>
</div>
<div class="section" id="refactoring-this-to-make-it-slightly-more-concise">
<h3>7.3.12. Refactoring this to make it slightly more concise –<a class="headerlink" href="#refactoring-this-to-make-it-slightly-more-concise" title="Permalink to this headline">¶</a></h3>
<p>We’ve got one more redundancy in this file - the <code class="docutils literal notranslate"><span class="pre">fastqc_output</span></code> is listed in the <code class="docutils literal notranslate"><span class="pre">all</span></code> rule, but you don’t need it there! Why?</p>
<p>Well, <code class="docutils literal notranslate"><span class="pre">multiqc_report.html</span></code> is already in the all rule, and the multiqc rule depends on <code class="docutils literal notranslate"><span class="pre">fastqc_output</span></code>, so <code class="docutils literal notranslate"><span class="pre">fastqc_output</span></code> already needs to be created to satisfy the all rule, so… specifying it in the all rule is redundant! And you can remove it!</p>
<p>(It’s not a big deal and I usually leave it in. But I wanted to talk about dependencies!)</p>
<p>The Snakefile now looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fastqc_output</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;data/0Hour_001_1_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/6Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
  <span class="s2">&quot;data/0Hour_001_2_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/6Hour_001_2_fastqc.html&quot;</span><span class="p">,</span>
  <span class="s2">&quot;data/0Hour_002_1_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/6Hour_002_1_fastqc.html&quot;</span><span class="p">,</span>
  <span class="s2">&quot;data/0Hour_002_2_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/6Hour_002_2_fastqc.html&quot;</span><span class="p">]</span>

<span class="n">rule</span> <span class="nb">all</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;multiqc_report.html&quot;</span>
    
<span class="n">rule</span> <span class="n">fastqc_a_file</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_fastqc.zip&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;fastqc </span><span class="si">{input}</span><span class="s2">&quot;</span>
    
<span class="n">rule</span> <span class="n">run_multiqc</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="n">fastqc_output</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;multiqc_report.html&quot;</span><span class="p">,</span>
    <span class="n">directory</span><span class="p">(</span><span class="s2">&quot;multiqc_data&quot;</span><span class="p">)</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;multiqc data/&quot;</span>
</pre></div>
</div>
<p>and we can rerun it from scratch by doing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rm</span> <span class="n">data</span><span class="o">/*.</span><span class="n">html</span> <span class="n">multiqc_report</span><span class="o">.</span><span class="n">html</span>
<span class="n">snakemake</span>
</pre></div>
</div>
</div>
<div class="section" id="digression-what-files-does-snakemake-check-in-order-to-decide-about-rerunning">
<h3>7.3.13. Digression: what files does snakemake check in order to decide about rerunning?<a class="headerlink" href="#digression-what-files-does-snakemake-check-in-order-to-decide-about-rerunning" title="Permalink to this headline">¶</a></h3>
<p>snakemake will compare only at the very initial input files, and the
specific output file(s) you are requesting, to decide if it needs to
rerun the workflow.</p>
<p>In practical terms, this means that if you just delete the
<code class="docutils literal notranslate"><span class="pre">data/*.html</span></code> files above but leave <code class="docutils literal notranslate"><span class="pre">multiqc_report.html</span></code> around,
snakemake won’t rerun anything. You have to delete both the
intermediaries <em>and</em> the end output files (as we do in the previous
section), <em>or</em> update the raw input files, in order to force
rerunning.</p>
<p>(<a class="reference external" href="https://bitbucket.org/snakemake/snakemake/issues/885/snakemake-sometimes-doesnt-run-rule-when">This is a feature, not a bug</a> - it helps deal with data-intensive pipelines where the intermediate files are really big.)</p>
</div>
<div class="section" id="making-a-clean-rule">
<h3>7.3.14. Making a <code class="docutils literal notranslate"><span class="pre">clean</span></code> rule<a class="headerlink" href="#making-a-clean-rule" title="Permalink to this headline">¶</a></h3>
<p>It’s kind of annoying to have to delete things explicitly. Snakemake should take care of that for us. Let’s add a new rule, <code class="docutils literal notranslate"><span class="pre">clean</span></code>, that forces rerunning of things –</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="n">clean</span><span class="p">:</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;rm -f </span><span class="si">{fastqc_output}</span><span class="s2"> multiqc_report.html&quot;</span>
</pre></div>
</div>
<p>and now try rerunning things:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snakemake</span> <span class="o">-</span><span class="n">p</span> <span class="n">clean</span>
<span class="n">snakemake</span>
</pre></div>
</div>
<p>A few things to point out –</p>
<ul class="simple">
<li>Here we see the use of variables inside a shell command, again - <code class="docutils literal notranslate"><span class="pre">{fastqc_output}</span></code> means “replace the thing in the curly quotes with the Python values in <code class="docutils literal notranslate"><span class="pre">fastqc_output</span></code>.</li>
<li>We’re using <code class="docutils literal notranslate"><span class="pre">snakemake</span> <span class="pre">-p</span></code> to get a printout of the commands that are run.</li>
</ul>
<p>What’s particularly nice about the <code class="docutils literal notranslate"><span class="pre">clean</span></code> rule (the name is a convention, not a requirement) is that you only need to keep track of the expected output files in one or two places - the all rule, and the clean rule.</p>
</div>
<div class="section" id="digression-running-things-in-parallel">
<h3>7.3.15. Digression: running things in parallel<a class="headerlink" href="#digression-running-things-in-parallel" title="Permalink to this headline">¶</a></h3>
<p>So, we’ve put all this work into making this snakefile with its input rules and its output rules… and there are a lot of advantages to our current approach already! Let’s list a few of them –</p>
<ul class="simple">
<li>we’ve completely automated our analysis!</li>
<li>we can easily add new data files into fastqc and multiqc!</li>
<li>we can rerun things easily, and (even better) by default only things that <em>need</em> to be run will be run.</li>
<li>the snakefile is actually pretty reusable - we could drop this into a new project, and, with little effort, run all of these things on new data!</li>
</ul>
<p>but there’s even more practical value in this, too – because we’ve given snakemake a recipe, rather than a script, we can now run these commands in parallel, too!</p>
<p>Try:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snakemake</span> <span class="n">clean</span>
<span class="n">snakemake</span> <span class="o">-</span><span class="n">j</span> <span class="mi">4</span>
</pre></div>
</div>
<p>this will run up to four things in parallel!</p>
</div>
<div class="section" id="doing-more-things-in-our-workflow">
<h3>7.3.16. Doing more things in our workflow.<a class="headerlink" href="#doing-more-things-in-our-workflow" title="Permalink to this headline">¶</a></h3>
<p>Let’s add some trimming!</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="n">trim_reads</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_1.fq.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_2.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_1.pe.qc.fq.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_1.se.qc.fq.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_2.pe.qc.fq.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_2.se.qc.fq.gz&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;trimmomatic PE {input} {output} LEADING:2 TRAILING:2 \</span>
<span class="sd">      SLIDINGWINDOW:4:15 \</span>
<span class="sd">      MINLEN:25&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>Points to make:</p>
<ul class="simple">
<li>I’m begin really careful about input and output filenames to make sure that the wildcards work properly, and that we can fastqc things properly!</li>
<li>the order of files in <code class="docutils literal notranslate"><span class="pre">{input}</span></code> and <code class="docutils literal notranslate"><span class="pre">{output}</span></code> matter - they’re passed in that order to snakemake! (See the output of <code class="docutils literal notranslate"><span class="pre">snakemake</span> <span class="pre">-p</span></code>.)</li>
</ul>
<p>Now add the appropriate files into the fastc output list too – change it to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fastqc_output</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;data/0Hour_001_1_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/6Hour_001_1_fastqc.html&quot;</span><span class="p">,</span>
  <span class="s2">&quot;data/0Hour_001_2_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/6Hour_001_2_fastqc.html&quot;</span><span class="p">,</span>
  <span class="s2">&quot;data/0Hour_002_1_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/6Hour_002_1_fastqc.html&quot;</span><span class="p">,</span>
  <span class="s2">&quot;data/0Hour_002_2_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/6Hour_002_2_fastqc.html&quot;</span><span class="p">,</span>
  <span class="s2">&quot;data/0Hour_001_1.pe.qc_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/0Hour_002_1.pe.qc_fastqc.html&quot;</span><span class="p">,</span>
  <span class="s2">&quot;data/6Hour_001_1.pe.qc_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/6Hour_002_1.pe.qc_fastqc.html&quot;</span><span class="p">,</span>
  <span class="s2">&quot;data/0Hour_001_2.pe.qc_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/0Hour_002_2.pe.qc_fastqc.html&quot;</span><span class="p">,</span>
  <span class="s2">&quot;data/0Hour_001_2.pe.qc_fastqc.html&quot;</span><span class="p">,</span> <span class="s2">&quot;data/0Hour_002_2.pe.qc_fastqc.html&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>and re-run everything:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snakemake</span> <span class="n">clean</span>
<span class="n">snakemake</span> <span class="o">-</span><span class="n">j</span> <span class="mi">4</span>
</pre></div>
</div>
<p>and voila - you’ve got a pile of trimmed output files, and a nice multiqc report on pre- and post- quality!</p>
<p>One other point to make: by naming the files “right”, i.e. by making the trimmed files meet the input requirements for the fastqc rule, we could automatically take advantage of that rule to run fastqc on them. A lot of snakemake seems to boil down to file naming, for better or for worse… :)</p>
</div>
</div>
<div class="section" id="more-advanced-snakemake">
<h2>7.4. More advanced snakemake<a class="headerlink" href="#more-advanced-snakemake" title="Permalink to this headline">¶</a></h2>
<div class="section" id="dry-run">
<h3>7.4.1. Dry run<a class="headerlink" href="#dry-run" title="Permalink to this headline">¶</a></h3>
<p>You can use <code class="docutils literal notranslate"><span class="pre">snakemake</span> <span class="pre">-n</span></code> to see what <em>would</em> be run, without actually running it! This is called a “dry run”. This is useful when you have really big compute.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snakemake</span> <span class="n">clean</span>
<span class="n">snakemake</span> <span class="o">-</span><span class="n">n</span>
</pre></div>
</div>
</div>
<div class="section" id="running-things-in-parallel-revisited">
<h3>7.4.2. Running things in parallel, revisited<a class="headerlink" href="#running-things-in-parallel-revisited" title="Permalink to this headline">¶</a></h3>
<p>Above, we saw that you can use <code class="docutils literal notranslate"><span class="pre">snakemake</span> <span class="pre">-j</span> <span class="pre">4</span></code> to run four jobs in parallel. Here are some other</p>
<ul class="simple">
<li>all the output is sort of smushed together… if a rule fails, it may be hard to figure out what happened. You can always just rerun snakemake.</li>
<li>still need to be careful about how much memory and processor you’re using!</li>
<li>can be used on a cluster, to distribute jobs across multiple compute nodes. (This requires more work; also see, Specifying required software.)</li>
</ul>
</div>
<div class="section" id="specifying-software-required-for-a-rule">
<h3>7.4.3. Specifying software required for a rule<a class="headerlink" href="#specifying-software-required-for-a-rule" title="Permalink to this headline">¶</a></h3>
<p>You can specify software on a per-rule basis! This is really helpful when you have incompatible software requirements for different rules, or want to run on a cluster, or just want to pin your snakemake workflow to a specific version.</p>
<p>For example, if you create a file <code class="docutils literal notranslate"><span class="pre">env_fastqc.yml</span></code> with the following content,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">channels</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">bioconda</span>
  <span class="o">-</span> <span class="n">defaults</span>
  <span class="o">-</span> <span class="n">conda</span><span class="o">-</span><span class="n">forge</span>
<span class="n">dependencies</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">fastqc</span><span class="o">==</span><span class="mf">0.11</span><span class="o">.</span><span class="mi">8</span>
</pre></div>
</div>
<p>and then change the fastqc rule to look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rule</span> <span class="n">fastqc_a_file</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_fastqc.zip&quot;</span>
  <span class="n">conda</span><span class="p">:</span>
    <span class="s2">&quot;env_fastqc.yml&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;fastqc </span><span class="si">{input}</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>you can now run snakemake like so,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snakemake</span> <span class="o">--</span><span class="n">use</span><span class="o">-</span><span class="n">conda</span>
</pre></div>
</div>
<p>and for that rule, snakemake will install just that software, with the specified version.</p>
<p>This aids in reproducibility, in addition to the practical advantages of isolating software installs from each other.</p>
<p>(You can also do this with docker and singularity containers, too!)</p>
</div>
<div class="section" id="outputting-the-entire-workflow-diagram">
<h3>7.4.4. Outputting the entire workflow diagram<a class="headerlink" href="#outputting-the-entire-workflow-diagram" title="Permalink to this headline">¶</a></h3>
<p>You can visualize your workflow like so!</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">snakemake</span> <span class="o">--</span><span class="n">dag</span> <span class="o">|</span> <span class="n">dot</span> <span class="o">-</span><span class="n">Tpng</span> <span class="o">&gt;</span> <span class="n">dag</span><span class="o">.</span><span class="n">png</span>
</pre></div>
</div>
</div>
<div class="section" id="adding-in-some-python">
<h3>7.4.5. Adding in some Python…<a class="headerlink" href="#adding-in-some-python" title="Permalink to this headline">¶</a></h3>
<p>You can add in some Python to load in the input files, like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">sys</span>
<span class="n">fastqc_input</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;data/?Hour_00?_?.fq.gz&#39;</span><span class="p">)</span>

<span class="n">fastqc_output</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">fastqc_input</span><span class="p">:</span>
  <span class="n">new_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_fastqc.html&#39;</span>
  <span class="n">fastqc_output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_filename</span><span class="p">)</span>

<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">fastqc_input</span><span class="p">:</span>
  <span class="n">new_filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.pe.qc_fastqc.html&#39;</span>
  <span class="n">fastqc_output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_filename</span><span class="p">)</span>
  
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;from these input files&#39;</span><span class="p">,</span> <span class="n">fastqc_input</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;I constructed these output filenames&#39;</span><span class="p">,</span> <span class="n">fastqc_output</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

<span class="n">rule</span> <span class="nb">all</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;multiqc_report.html&quot;</span>
    
<span class="n">rule</span> <span class="n">clean</span><span class="p">:</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;rm -f </span><span class="si">{fastqc_output}</span><span class="s2"> multiqc_report.html&quot;</span>

<span class="n">rule</span> <span class="n">fastqc_a_file</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{arglebarf}</span><span class="s2">.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{arglebarf}</span><span class="s2">_fastqc.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="si">{arglebarf}</span><span class="s2">_fastqc.zip&quot;</span>
  <span class="n">conda</span><span class="p">:</span>
    <span class="s2">&quot;env_fastqc.yml&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;fastqc </span><span class="si">{input}</span><span class="s2">&quot;</span>

    
<span class="n">rule</span> <span class="n">run_multiqc</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="n">fastqc_output</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;multiqc_report.html&quot;</span><span class="p">,</span>
    <span class="n">directory</span><span class="p">(</span><span class="s2">&quot;multiqc_data&quot;</span><span class="p">)</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="s2">&quot;multiqc data/&quot;</span>

<span class="n">rule</span> <span class="n">trim_reads</span><span class="p">:</span>
  <span class="nb">input</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_1.fq.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_2.fq.gz&quot;</span>
  <span class="n">output</span><span class="p">:</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_1.pe.qc.fq.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_1.se.qc.fq.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_2.pe.qc.fq.gz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">_2.se.qc.fq.gz&quot;</span>
  <span class="n">shell</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;trimmomatic PE {input} {output} LEADING:2 TRAILING:2 \</span>
<span class="sd">      SLIDINGWINDOW:4:15 \</span>
<span class="sd">      MINLEN:25&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>Take a look at <a class="reference external" href="https://snakemake.readthedocs.io/en/stable/project_info/faq.html#how-do-i-run-my-rule-on-all-files-of-a-certain-directory">glob_wildcards</a> as well.</p>
</div>
<div class="section" id="final-thoughts-writing-your-own-snakefile">
<h3>7.4.6. Final thoughts - writing your own snakefile<a class="headerlink" href="#final-thoughts-writing-your-own-snakefile" title="Permalink to this headline">¶</a></h3>
<p>Just like scripting, or writing an R script, writing a snakefile is a kind of programming. So you’ll have to do a lot of debugging :) :(. A few thoughts for you on how to do this:</p>
<ul class="simple">
<li>start small, grow your snakefile!</li>
<li>DO copy and paste from this tutorial and others you find online!</li>
<li>it rarely hurts to just re-run snakemake!</li>
</ul>
</div>
</div>
<div class="section" id="thinking-about-workflows-a-strong-er-argument">
<h2>7.5. Thinking about workflows - a strong(er) argument<a class="headerlink" href="#thinking-about-workflows-a-strong-er-argument" title="Permalink to this headline">¶</a></h2>
<p>what do (snakemake) workflows do for me?</p>
<p>A laundry list:</p>
<ul class="simple">
<li>declarative vs procedural specification<ul>
<li>allows analysis of workflow graph, parallelization</li>
<li>allows declaration of specific software needed, for later tracking</li>
<li>can compare workflows more easily, in theory (=&gt; reproducibility)</li>
<li>can rerun failed steps</li>
</ul>
</li>
<li>tracks dependencies on files<ul>
<li>allows rerunning just the bits that need to rerun</li>
</ul>
</li>
<li>reusability, in theory</li>
<li>different conda environments for each step<ul>
<li>allows pinning of software versions</li>
<li>allows use of potentially incompatible software</li>
</ul>
</li>
</ul>
<p>For me, the main reason to use snakemake is that it lets be sure that my workflow completed properly. snakemake tracks which commands fails, and will stop the workflow in its tracks! This is not something that you usually do in shell scripts.</p>
<p>(It turns out that I’ve spent a lot of my life being a bit paranoid about whether my commands actually ran correctly!)</p>
<div class="section" id="dealing-with-complexity">
<h3>7.5.1. Dealing with complexity<a class="headerlink" href="#dealing-with-complexity" title="Permalink to this headline">¶</a></h3>
<p>Workflows can get really complicated; <a class="reference external" href="https://github.com/spacegraphcats/2018-paper-spacegraphcats/blob/master/pipeline-base/Snakefile">here</a>, for example, is one for our most recent paper. But it’s all just using the building blocks that I showed you above!</p>
<p>If you want to see some good examples of how to build nice, clean, simple looking workflows, check out <a class="reference external" href="https://github.com/snakemake-workflows/rna-seq-star-deseq2">this RNAseq example</a>.</p>
</div>
<div class="section" id="go-forth-and-workflow">
<h3>7.5.2. Go forth and Workflow!<a class="headerlink" href="#go-forth-and-workflow" title="Permalink to this headline">¶</a></h3>
</div>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="introduction.html" title="previous chapter (use the left arrow)">6. Introduction</a>
      </div>
    
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="introduction.html" title="6. Introduction"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="toc.html">snakemake2019 0.0.1 documentation</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright 2019, Sateesh Peri. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  </body>
</html>